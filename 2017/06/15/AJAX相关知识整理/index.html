<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/icon.ico?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="全平台兼容的XMLHttpRequest对象 在标准浏览器中可以使用XMLHttpRequest()创建Ajax请求的对象。  IE的&amp;gt;=7以上版本支持XMLHttpRequest对象,在之前的版本中需要指明一个类似于”Microsoft.XMLHttp”的progID,且在不同的操作系统下,以下的ProgId都可以创建XMLHttp对象。">
<meta name="keywords" content="原生ajax、跨域、jQuery的ajax、CSRF">
<meta property="og:type" content="article">
<meta property="og:title" content="AJAX相关知识整理">
<meta property="og:url" content="https://corbusier.github.io/2017/06/15/AJAX相关知识整理/index.html">
<meta property="og:site_name" content="Awesome_929">
<meta property="og:description" content="全平台兼容的XMLHttpRequest对象 在标准浏览器中可以使用XMLHttpRequest()创建Ajax请求的对象。  IE的&amp;gt;=7以上版本支持XMLHttpRequest对象,在之前的版本中需要指明一个类似于”Microsoft.XMLHttp”的progID,且在不同的操作系统下,以下的ProgId都可以创建XMLHttp对象。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://corbusier.github.io/images/ajax.png">
<meta property="og:updated_time" content="2017-06-15T05:11:50.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="AJAX相关知识整理">
<meta name="twitter:description" content="全平台兼容的XMLHttpRequest对象 在标准浏览器中可以使用XMLHttpRequest()创建Ajax请求的对象。  IE的&amp;gt;=7以上版本支持XMLHttpRequest对象,在之前的版本中需要指明一个类似于”Microsoft.XMLHttp”的progID,且在不同的操作系统下,以下的ProgId都可以创建XMLHttp对象。">
<meta name="twitter:image" content="https://corbusier.github.io/images/ajax.png">






  <link rel="canonical" href="https://corbusier.github.io/2017/06/15/AJAX相关知识整理/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>AJAX相关知识整理 | Awesome_929</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Awesome_929</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />Tags</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-about"></i> <br />About</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archives"></i> <br />Archives</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://corbusier.github.io/2017/06/15/AJAX相关知识整理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zoe">
      <meta itemprop="description" content="心之所向，素履以往。">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Awesome_929">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">AJAX相关知识整理
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2017-06-15 13:11:50" itemprop="dateCreated datePublished" datetime="2017-06-15T13:11:50+08:00">2017-06-15</time>
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/AJAX/" itemprop="url" rel="index"><span itemprop="name">AJAX</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><img src="/images/ajax.png" alt="ajax" align="center" width="640px" height="280px"></p>
<h2 id="全平台兼容的XMLHttpRequest对象"><a href="#全平台兼容的XMLHttpRequest对象" class="headerlink" title="全平台兼容的XMLHttpRequest对象"></a>全平台兼容的XMLHttpRequest对象</h2><blockquote>
<p>在标准浏览器中可以使用XMLHttpRequest()创建Ajax请求的对象。</p>
</blockquote>
<p>IE的&gt;=7以上版本支持XMLHttpRequest对象,在之前的版本中需要指明一个类似于”Microsoft.XMLHttp”的progID,且在不同的操作系统下,以下的ProgId都可以创建XMLHttp对象。<br><a id="more"></a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Microsoft.XMLHTTP</span><br><span class="line">Microsoft.XMLHTTP<span class="number">.1</span><span class="number">.0</span></span><br><span class="line">Msxml2.ServerXMLHTTP</span><br><span class="line">Msxml2.ServerXMLHTTP<span class="number">.3</span><span class="number">.0</span></span><br><span class="line">Msxml2.ServerXMLHTTP<span class="number">.4</span><span class="number">.0</span></span><br><span class="line">Msxml2.ServerXMLHTTP<span class="number">.5</span><span class="number">.0</span></span><br><span class="line">   Msxml2.ServerXMLHTTP<span class="number">.6</span><span class="number">.0</span></span><br><span class="line">Msxml2.XMLHTTP</span><br><span class="line">Msxml2.XMLHTTP<span class="number">.3</span><span class="number">.0</span></span><br><span class="line">Msxml2.XMLHTTP<span class="number">.4</span><span class="number">.0</span></span><br><span class="line">Msxml2.XMLHTTP<span class="number">.5</span><span class="number">.0</span></span><br><span class="line">Msxml2.XMLHTTP<span class="number">.6</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>以上的版本中6的功能最强,且更安全,但是只有Vista系统及以上才可使用,4已经被5完全替代,而5是针对Office办公场景的,在没有安装office2003前提下,不一定能使用它。所以3是6的优雅降级版本,适用于Win2k SP4及以上系统。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function getXHR()&#123;</span><br><span class="line"> var xhr = null;</span><br><span class="line"> if(window.XMLHttpRequest)&#123;</span><br><span class="line">  xhr = new XMLHttpRequest();</span><br><span class="line"> &#125;else if(window.ActiveXObject)&#123;</span><br><span class="line">     try&#123;</span><br><span class="line">  xhr = new ActiveXObject(&quot;Msxml2.XMLHttp&quot;);</span><br><span class="line">     &#125;catch(e)&#123;</span><br><span class="line">			try&#123;</span><br><span class="line">			    xhr = new ActiveXObject(&quot;Microsoft.XMLHttp&quot;);</span><br><span class="line">			&#125;catch(e)&#123;</span><br><span class="line">			    alert(&quot;您的浏览器暂不支持Ajax!&quot;)</span><br><span class="line">         &#125;</span><br><span class="line">		&#125;</span><br><span class="line"> &#125;</span><br><span class="line"> return xhr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h2 id="Ajax有没有破坏JS单线程机制"><a href="#Ajax有没有破坏JS单线程机制" class="headerlink" title="Ajax有没有破坏JS单线程机制"></a>Ajax有没有破坏JS单线程机制</h2><p>一般情况下,浏览器分为以下几个线程:</p>
<ol>
<li>GUI渲染线程</li>
<li>JS引擎线程</li>
<li>浏览器事件触发线程</li>
<li>HTTP请求线程</li>
</ol>
<p>通常情况下,线程间交互以事件形式发生,通过事件回调的方式予以通知,而事件回调又是先入先出的队列形式将时间添加到任务队列的末尾,等JS引擎空闲时,再依次执行排队的任务,事件回调包括setTimeout、setInterval,click,ajax异步请求等回调。</p>
<p>在浏览器中JS引擎线程会循环从任务队列中读取事件并执行,这样的机制被称为Event Loop(事件循环)。</p>
<p>对于Ajax请求,先创建对象,在执行open调用send方法至此均为同步执行,直到send开始,浏览器为将要发生的网络请求创建了新的HTTP请求线程,它与JS引擎线程相对独立,网络异步请求发送时,JS引擎并不会等到Http收到结果,而是直接顺序向下执行。</p>
<p>当Ajax请求被服务器响应并收到response后,浏览器事件触发机制捕获到了Ajax回调函数onreadystatechange(也可能是onload,onerror等)。该事件并没有立即执行,而是添加到任务队列的末尾,等到JS引擎空闲了再执行。</p>
<p>在onreadystatechange事件内部中,可能会有DOM操作,此时便会挂起JS引擎线程,执行GUI渲染,当JS引擎重新执行时GUI渲染线程才会挂起,GUI更新被保存起来,等JS引擎空闲后再立即执行。</p>
<p>以上的整个Ajax请求过程中,涉及到了四个线程,除了互斥的GUI渲染和JS引擎线程,其他都是可以并行执行的,通过这样的方式,ajax并没有破坏js的单线程机制。</p>
<h2 id="Ajax与setTimeout排队问题"><a href="#Ajax与setTimeout排队问题" class="headerlink" title="Ajax与setTimeout排队问题"></a>Ajax与setTimeout排队问题</h2><p>通常情况下,Ajax会与setTimeout同等对待,按照顺序自动的添加到任务队列的末尾,等待JS引擎空闲时执行,但并非xhr的所有回调执行都滞后于setTimeout的回调。例如:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">function ajax(url,method)&#123;</span><br><span class="line">    var xhr = getXHR();</span><br><span class="line">    xhr.onreadystatechange = function()&#123;</span><br><span class="line">        console.log(&quot;xhr.readyState:&quot; + this.readyState);</span><br><span class="line">    &#125;</span><br><span class="line">    xhr.loadstart = function()&#123;</span><br><span class="line">        console.log(&quot;loadstart&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    xhr.load = function()&#123;</span><br><span class="line">        console.log(&quot;onload&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    xhr.open(method,url,true);</span><br><span class="line">    xhr.setRequestHeader(&quot;Cache-Control&quot;,3000);</span><br><span class="line">    xhr.send();</span><br><span class="line">&#125;</span><br><span class="line">var timer = setTimeout(function()&#123;</span><br><span class="line">    console.log(&quot;setTimeout&quot;)</span><br><span class="line">&#125;,0);</span><br><span class="line">ajax(&quot;http://www.baidu.com&quot;,&quot;GET&quot;)</span><br><span class="line">console.warn(&quot;这里并不是最先打印出来的&quot;)</span><br></pre></td></tr></table></figure></p>
<p>结果为:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xhr.readyState:1</span><br><span class="line">onloadStart</span><br><span class="line">这里并不是最先打印出来</span><br><span class="line">xhr.readyState:4</span><br></pre></td></tr></table></figure></p>
<pre><code>由此可见并非所有的Ajax请求都是异步的,至少readystatechange回调及loadstart回调都是同步函数。
</code></pre><h2 id="原生AJAX封装方法"><a href="#原生AJAX封装方法" class="headerlink" title="原生AJAX封装方法"></a>原生AJAX封装方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">   function Ajax(params)&#123;</span><br><span class="line">	params = params || &#123;&#125;;</span><br><span class="line">	params.data = params.data || &#123;&#125;;</span><br><span class="line">	//判断是ajax请求还是jsonp请求</span><br><span class="line">	var json = params.jsonp?jsonp(params):json(params);</span><br><span class="line">	</span><br><span class="line">	//ajax请求</span><br><span class="line">	function json(params)&#123;</span><br><span class="line">		params.type = (params.type || &quot;GET&quot;).toUpperCase();</span><br><span class="line">		//格式化传输数据</span><br><span class="line">		params.data = formatParams(params.data);</span><br><span class="line"></span><br><span class="line">		var xhr = getXHR();</span><br><span class="line">		//readyState变化就会调用readystatechange 事件</span><br><span class="line">		xhr.onreadystatechange = function()&#123;</span><br><span class="line">			if(xhr.readyState == 4)&#123;</span><br><span class="line">				var status = xhr.status;</span><br><span class="line">				var response;</span><br><span class="line">				if(status&gt;=200 &amp;&amp; status&lt;300 || status == 304)&#123;</span><br><span class="line">					//判断接收数据的内容类型</span><br><span class="line">					var type = xhr.getResponseHeader(&quot;Content-Type&quot;);</span><br><span class="line">					if(type.indexOf(&quot;xml&quot;) !== -1 &amp;&amp; xhr.responseXML)&#123;</span><br><span class="line">						response = xhr.responseXML;</span><br><span class="line">					&#125;else if(type == &quot;application/json&quot;)&#123;</span><br><span class="line">						response = JSON.parse(xhr.responseText);//返回JSON响应</span><br><span class="line">					&#125;else&#123;</span><br><span class="line">						response = xhr.responseText;//字符串响应</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				//成功时返回数据</span><br><span class="line">				params.success &amp;&amp; params.success(response);			</span><br><span class="line">			&#125;else&#123;</span><br><span class="line">				params.error &amp;&amp; params.error(status);</span><br><span class="line">				//失败时直接返回失败状态码</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		if(params.type == &quot;GET&quot;)&#123;</span><br><span class="line">			//GET需要将URL末尾的字符串进行编码之后才可以使用</span><br><span class="line">			xhr.open(params.type,params.url + &quot;?&quot; + params.data,true);</span><br><span class="line">			xhr.send(null);</span><br><span class="line">		&#125;else&#123;</span><br><span class="line">			xhr.open(params.type,params.url,true);</span><br><span class="line">			//模拟表单设置请求头,提交时的内容类型</span><br><span class="line">			xhr.setRequestHeader(&quot;Content-Type&quot;,&quot;application/x-www-form-urlencoded;&quot;);</span><br><span class="line">			xhr.send(params.data);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		function formatParams(data)&#123;</span><br><span class="line">			var arr = [];</span><br><span class="line">			for(var key in data)&#123;</span><br><span class="line">				arr.push(encodeURIComponent(key) + &quot;=&quot; + encodeURIComponent(data[key]));</span><br><span class="line">			&#125;;</span><br><span class="line">			//添加随机数参数,防止缓存</span><br><span class="line">			arr.push(&quot;v=&quot; + random());</span><br><span class="line">			return arr.join(&quot;&amp;&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		function random()&#123;</span><br><span class="line">			return Math.floor(Math.random() * 1000 + 500);</span><br><span class="line">		&#125;</span><br><span class="line">		//除了设置随机数之外,还可以设置请求头来防止缓存</span><br><span class="line">		xhr.setRequestHeader(&quot;Cache-Control&quot;,&quot;no-cache&quot;);</span><br><span class="line">		</span><br><span class="line">		//在JQuery中在setting里面指定或者全局关闭缓存</span><br><span class="line">		cache:true</span><br><span class="line">		$.ajaxSetup(&#123;cache:false&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">//使用实例:</span><br><span class="line">Ajax(&#123;</span><br><span class="line">	url : &quot;test.php&quot;,</span><br><span class="line">	type : &quot;POST&quot;,</span><br><span class="line">	data : &#123;&quot;carry&quot; : &quot;异步请求&quot;&#125;,</span><br><span class="line">	success : function(res)&#123;</span><br><span class="line">		console.log(JSON.parse(res));</span><br><span class="line">	&#125;,</span><br><span class="line">	error : function(error)&#123;</span><br><span class="line">		console.log(&quot;Not Found&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="JSONP"><a href="#JSONP" class="headerlink" title="JSONP"></a>JSONP</h2><h3 id="同源策略"><a href="#同源策略" class="headerlink" title="同源策略"></a>同源策略</h3><p>AJAX需要跨域就是因为浏览器的同源策略。一个页面的AJAX只能获取这个页面相同源或相同域的数据。同源或者同域—-协议、域名、端口号都必须相同。</p>
<p>可以使用JSONP进行跨域请求,利用script标签可以跨域请求的特性,由其src属性发送请求到服务器,服务器返回JS代码,浏览器接受响应,然后直接执行。这个与加载外部文件原理相同。</p>
<p>JSONP由两部分组成：回调函数和数据,回调函数一般是在浏览器控制,作为参数发往服务器端。当服务器响应时,服务器端就会把该函数和数据拼成字符串返回。</p>
<p>请求过程：</p>
<ul>
<li>请求阶段：浏览器创建一个script标签,并给其src赋值(类似于<a href="http://example.com/api/?callback=jsonpCallback" target="_blank" rel="noopener">http://example.com/api/?callback=jsonpCallback</a>)</li>
<li>发送请求：当给script标签的src赋值时,浏览器就会发起一个请求。</li>
<li>数据响应：服务端将要返回的数据作为参数和函数名称拼接在一起返回。当浏览器接收到了响应数据,由于发起请求的是script,所以相当于直接调用jsonpCallback方法,并且传入了一个参数。</li>
</ul>
<p>JSONP的配置参数多了一个jsonp参数,即callback函数名。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">Ajax</span>(<span class="params">params</span>)</span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">jsonp</span>(<span class="params">params</span>)</span>&#123; </span><br><span class="line">        <span class="comment">//创建script标签并加入到页面中 </span></span><br><span class="line">        <span class="keyword">var</span> callbackName = params.jsonp; </span><br><span class="line">        <span class="keyword">var</span> head = <span class="built_in">document</span>.getElementsByTagName(<span class="string">'head'</span>)[<span class="number">0</span>]; </span><br><span class="line">        <span class="comment">// 设置传递给后台的回调参数名 </span></span><br><span class="line">        params.data[<span class="string">'callback'</span>] = callbackName; </span><br><span class="line">        <span class="keyword">var</span> data = formatParams(params.data); </span><br><span class="line">        <span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>); </span><br><span class="line">        head.appendChild(script);  </span><br><span class="line">	      </span><br><span class="line">        <span class="comment">//创建jsonp回调函数 </span></span><br><span class="line">           <span class="built_in">window</span>[callbackName] = <span class="function"><span class="keyword">function</span>(<span class="params">json</span>)</span>&#123; </span><br><span class="line">	        head.removeChild(script); </span><br><span class="line">	        clearTimeout(script.timer); </span><br><span class="line">	        <span class="built_in">window</span>[callbackName] = <span class="literal">null</span>; </span><br><span class="line">            params.success &amp;&amp; params.success(json); </span><br><span class="line">	    &#125;;  </span><br><span class="line">	   </span><br><span class="line">           <span class="comment">//发送请求 </span></span><br><span class="line">        script.src = params.url + <span class="string">'?'</span> + data;  </span><br><span class="line">	    </span><br><span class="line">        <span class="comment">//为了得知此次请求是否成功，设置超时处理 </span></span><br><span class="line">        <span class="keyword">if</span>(params.time)&#123;</span><br><span class="line">               script.timer = setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                   <span class="built_in">window</span>[callbackName] = <span class="literal">null</span>; </span><br><span class="line">                   head.removeChild(script); </span><br><span class="line">                   params.error &amp;&amp; params.error(&#123;</span><br><span class="line">                       message : <span class="string">"超市"</span></span><br><span class="line">                   &#125;);</span><br><span class="line">               &#125;,time)</span><br><span class="line">           &#125;</span><br><span class="line">        <span class="comment">//格式化参数 </span></span><br><span class="line">	    <span class="function"><span class="keyword">function</span> <span class="title">formatParams</span>(<span class="params">data</span>) </span>&#123; </span><br><span class="line">	        <span class="keyword">var</span> arr = []; </span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> name <span class="keyword">in</span> data) &#123; </span><br><span class="line">                arr.push(<span class="built_in">encodeURIComponent</span>(name) + <span class="string">'='</span> + <span class="built_in">encodeURIComponent</span>(data[name])); </span><br><span class="line">            &#125;;</span><br><span class="line">        <span class="comment">// 添加一个随机数，防止缓存 </span></span><br><span class="line">	        arr.push(<span class="string">'v='</span> + random()); </span><br><span class="line">            <span class="keyword">return</span> arr.join(<span class="string">"&amp;"</span>); </span><br><span class="line">	    &#125; </span><br><span class="line">	    </span><br><span class="line">        <span class="comment">// 获取随机数 </span></span><br><span class="line">	    <span class="function"><span class="keyword">function</span> <span class="title">random</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">               <span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">10000</span> + <span class="number">500</span>); </span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意：script标签只在第一次设置时起作用,导致script标签没法重用,所以每次操作完之后都要移除;<br>使用实例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ajax(&#123;</span><br><span class="line">    url : &quot;test.php&quot;,</span><br><span class="line">    jsonp : &quot;jsonpCallback&quot;,</span><br><span class="line">    data : &#123;&quot;carry&quot; : &quot;异步请求&quot;&#125;,</span><br><span class="line">    success : function(res)&#123;</span><br><span class="line">        console.log(res);</span><br><span class="line">    &#125;,</span><br><span class="line">    error : function(error)&#123;</span><br><span class="line">        console.log(&quot;Not Found&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h2 id="XMLHttpRequest实例的属性"><a href="#XMLHttpRequest实例的属性" class="headerlink" title="XMLHttpRequest实例的属性"></a>XMLHttpRequest实例的属性</h2><ul>
<li><p>readyState属性<br> 从0-4代表了HTTP请求的状态。<br> 0，UNSENT。实例已经生成,但是open方法还没有被调用。<br> 1，Opened。open已调用,但send还没有被调用,仍然可以使用setRequestHeader,设定请求头。<br> 2，HEADERS_RECEIVED,send方法已经执行,并且头信息和状态码已经收到。<br> 3，LOADING,正在接收服务器传来的主体部分的数据。<br> 4，DONE,数据接收完成,或者接收失败。</p>
</li>
<li><p>status<br> 只读属性,表示本次请求得到的HTTP状态码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">200，OK，访问正常</span><br><span class="line">301，永久移动</span><br><span class="line">302，暂时移动</span><br><span class="line">304，未修改</span><br><span class="line">307，暂时重定向</span><br><span class="line">401，未授权</span><br><span class="line">403，禁止访问</span><br><span class="line">404，未发现指定网址</span><br><span class="line">500，服务器发生错误</span><br></pre></td></tr></table></figure>
</li>
<li><p>statusText<br>只读属性,访问一个字符串,表示服务器发送的状态提示。不属于status属性的是,该属性包含整个状态信息,比如””200 OK”。</p>
</li>
<li><p>timeout<br>设定超限时间,超过了时间没有得到结果就会自动终止,关于该属性的监听函数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xhr.ontimeout = function()&#123;</span><br><span class="line">    //时间超时</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>response<br>只读属性,返回接收到的数据体。可以是ArrayBuffer(缓冲数组)、Blob(二进制对象)、Document、JSON对象或者一个字符串。如果请求成功或者数据不完整，该属性就会等于null。</p>
</li>
<li>responseType<br>指定返回数据(xhr.response)的类型<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;&quot;:字符串(默认值)</span><br><span class="line">&quot;arraybuffer&quot;:ArrayBuffer对象</span><br><span class="line">&quot;blob&quot;:Blob对象</span><br><span class="line">&quot;document&quot;:Document对象</span><br><span class="line">&quot;json&quot;:JSON对象</span><br><span class="line">&quot;text&quot;:字符串</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>blob对象适用于图片文件,Document类型适合XML文档,大多数情况下使用text类型</p>
<ul>
<li><p>responseText<br>只读属性,请求不成功或数据不完整,该属性为null,如果返回的数据格式是JSON,就可以使用responseText属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var data = xhr.responseText;</span><br><span class="line">data = JSOn.parse(data);</span><br></pre></td></tr></table></figure>
</li>
<li><p>事件监听接口<br>在XHR 1.0版本中只能对onreadystatechange指定回调函数,而xhr 2.0中允许更多的事件指定回调函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">onloadstart 请求发出  </span><br><span class="line">onprogress 正在发送和加载数据  </span><br><span class="line">onabort 请求被中止，比如用户调用了abort()方法  </span><br><span class="line">onerror 请求失败  </span><br><span class="line">onload 请求成功完成  </span><br><span class="line">ontimeout 用户指定的时限到期，请求还未完成  </span><br><span class="line">onloadend 请求完成，不管成果或失败</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="XHR一级与XHR二级"><a href="#XHR一级与XHR二级" class="headerlink" title="XHR一级与XHR二级"></a>XHR一级与XHR二级</h2><p>XHR一级的缺点：</p>
<ul>
<li>仅支持文本数据传输,无法传输二进制数据。</li>
<li>传输数据时,没有进度消息提示</li>
<li>受浏览器同源策略限制,只能请求同域资源</li>
<li>没有超时机制,不方便掌控ajax请求节奏</li>
</ul>
<p>XHR二级的改进：</p>
<ul>
<li>支持二进制数据,可以上传文件,可以使用FormData对象管理表单</li>
<li>提供进度支持,通过xhr.upload.onprogress事件回调函数获取传输进度</li>
<li>仍然受同源策略限制,XHR二级新提供Access-Control-Allow-Origin等headers,设置为   从而实现跨域访问</li>
<li>可以设置timeout和ontimeout,方便设置超时时长和超时后续处理</li>
</ul>
<p>IE10以上都支持XHR2,对于IE8,9用户使用只对IE有效的的过渡方案。</p>
<h2 id="JQuery中的AJAX"><a href="#JQuery中的AJAX" class="headerlink" title="JQuery中的AJAX"></a>JQuery中的AJAX</h2><p>直接封装在JQuery类上的静态方法,JQ所有的ajax请求都是通过该方法实现的。在1.5版本之后的XHR对象实现了promise。</p>
<table>
<thead>
<tr>
<th>新方法</th>
<th>被替代的方法</th>
</tr>
</thead>
<tbody>
<tr>
<td>done(function(data,textStatus,jqXHR){})</td>
<td>success</td>
</tr>
<tr>
<td>fail(function(jqXHR,textStatus,errorThrown){})</td>
<td>error</td>
</tr>
<tr>
<td>always(function(data or jqXHR,textStatus,jqXHR or errorThrown){})</td>
<td>complete</td>
</tr>
</tbody>
</table>
<p>以上的三种方法按照队列函数原则可以分配多个回调。</p>
<h2 id="cookie、localstorage、sessionstorage"><a href="#cookie、localstorage、sessionstorage" class="headerlink" title="cookie、localstorage、sessionstorage"></a>cookie、localstorage、sessionstorage</h2><h3 id="共同点"><a href="#共同点" class="headerlink" title="共同点"></a>共同点</h3><p>都可以在浏览器端上储存数据。</p>
<h3 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h3><ul>
<li>大小限制</li>
<li>储存路径</li>
<li>接口数量</li>
<li>生存周期</li>
<li>参与通信,发送给服务器</li>
</ul>
<p>具体如下：</p>
<p>cookie主要用于用户的识别身份,且每次的通信过程中都会在HTTP的头部中携带,为了节省带宽优化性能,一般只有4K左右大小。默认是关闭浏览器后失效,可以设置失效时间。</p>
<p>webstorage的两种方式不会参与到通信中,虽然有大小的限制,但可以&gt;=5M,接口也更为丰富,可以将数据更新的通知发送给监听者。</p>
<p>其中localstorage可以永久保存,除非手动移除,否则手动的移除。<br>sessionstorage只在会话阶段有效,之后就失效了,作用域也不相同,在不同的浏览器窗口中,即使是同一个页面,sessionstorage也也不可以共享。而localstorage在所有同源窗口中共享。</p>
<h3 id="webstorage的用法"><a href="#webstorage的用法" class="headerlink" title="webstorage的用法"></a>webstorage的用法</h3><p>保存数据：localStorage.setItem(key,value);<br>读取数据：localStorage.getItem(key);<br>删除单个数据：localStorage.removeItem(key);<br>删除所有数据：localStorage.clear();<br>得到某个索引的key：localStorage.key(index);示例：</p>
<h4 id="监听-storage-事件"><a href="#监听-storage-事件" class="headerlink" title="监听 storage 事件"></a>监听 storage 事件</h4><p>触发事件的时间对象（e 参数值）有几个属性：</p>
<ol>
<li>key : 键值。</li>
<li>oldValue : 被修改前的值。</li>
<li>newValue : 被修改后的值。</li>
<li>url : 页面url。</li>
<li>storageArea : 被修改的 storage 对象。</li>
</ol>
<p>对应的处理事件函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">window.addEventListener(&apos;storage&apos;,function(e)&#123;</span><br><span class="line">    console.log(&apos;key=&apos;+e.key+&apos;,oldValue=&apos;+e.oldValue+&apos;,newValue=&apos;+e.newValue);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h2 id="AJAX跨域请求"><a href="#AJAX跨域请求" class="headerlink" title="AJAX跨域请求"></a>AJAX跨域请求</h2><h3 id="什么是CORS-cross-origin-resource-sharing"><a href="#什么是CORS-cross-origin-resource-sharing" class="headerlink" title="什么是CORS(cross-origin-resource-sharing)"></a>什么是CORS(cross-origin-resource-sharing)</h3><p>允许AJAX向跨域服务器发出异步http请求,克服同源策略的限制,实际上浏览器并不会阻止不合法的跨域请求,服务器收到了请求,只是浏览器拦截了传回来的响应,因此不合法(除了Chrome和FF下的https网站不允许发送http异步请求)。</p>
<h3 id="跨域的实现原理"><a href="#跨域的实现原理" class="headerlink" title="跨域的实现原理"></a>跨域的实现原理</h3><p>通过自定义的HTTP头部让浏览器与服务器进行沟通,从而决定请求或相应是成功还是失败。在请求时附加一个Orgin头部,其中包含请求页面的源信息(协议、域名和端口),以便服务器根据这个头部信息确定是否给予响应。示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Origin:http://www.nczonline.net</span><br></pre></td></tr></table></figure></p>
<p>如果服务器认为可以接受,就在Access-Control-Allow-Origin头部返回相同的源信息,出于安全策略的考虑,跨域时请求和响应都不能包含cookie信息。</p>
<h3 id="IE8、9的XDomainRequest"><a href="#IE8、9的XDomainRequest" class="headerlink" title="IE8、9的XDomainRequest"></a>IE8、9的XDomainRequest</h3><p>XDomainRequest仅可用于发送GET和POST请求,如下即创建过程：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var xdr = new XDomainRequest();</span><br></pre></td></tr></table></figure></p>
<p>xdr具有以下属性：</p>
<ul>
<li>timeout</li>
<li>responseText<br>如下方法：</li>
<li>open：只能接收Method,url两个参数。只有post和get方式,只能发送异步请求</li>
<li>send</li>
<li>abort<br>如下事件回调：</li>
<li>onprogress</li>
<li>ontimeout</li>
<li>onerror</li>
<li>onload</li>
</ul>
<p>还有两点需要注意的是：</p>
<ol>
<li>XDomainRequest不支持跨域传输cookie</li>
<li>只能设置请求头的Content-Type字段,不能访问响应头信息(getResponseHeader/getAllResponseHeaders),不能获取到status属性和statusText,只能获取到原始的响应文本。</li>
</ol>
<h3 id="其他浏览器的跨域实现"><a href="#其他浏览器的跨域实现" class="headerlink" title="其他浏览器的跨域实现"></a>其他浏览器的跨域实现</h3><p>针对XHR对象的原生支持,无需额外添加代码,只要在open时加入绝对的URL即可。与IE中的XDR不同的是,跨域的XHR可以访问status、statusText属性。并且支持同步请求。出于安全策略考虑也有一些限制：</p>
<ul>
<li>不能使用setRequestHeader设置自定义头部；</li>
<li>不能发送、接收cookie；</li>
<li>调用getAllResponseHeaders方法总会返回空字符串；</li>
</ul>
<h3 id="其他跨域技术"><a href="#其他跨域技术" class="headerlink" title="其他跨域技术"></a>其他跨域技术</h3><h4 id="JSONP-1"><a href="#JSONP-1" class="headerlink" title="JSONP"></a>JSONP</h4><p>JSON with padding的简写,应用JSON的一种新方法。包含在函数调用中的JSON,如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">callback(&#123;&quot;name&quot;:&quot;Nicholas&quot;&#125;);</span><br></pre></td></tr></table></figure></p>
<p>JSONP由两部分组成,回调函数和数据。回调函数的名字一般是在请求中指定的。而数据就是传入回调函数中的JSON数据。下面是一个典型的JSONP请求:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://freegeoip.net/json/?callback=handleResposne</span><br></pre></td></tr></table></figure></p>
<p>JSONP是通过动态script元素来使用的,使用时可以为src属性指定一个跨域URL,这里的script元素和img元素类似,都能不受限制的从其他域加载资源。作为一段有效的代码,在加入body之后,就可以立即执行返回JSON数据的callback。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function handleResponse(response)&#123;</span><br><span class="line">    alert(&quot;You&apos;re at IP address&quot; + response.ip + &quot;,which is in &quot; + response.city + &quot;, &quot; + response.region_name);</span><br><span class="line">&#125;</span><br><span class="line">var script = document.createElement(&quot;script&quot;);</span><br><span class="line">script.src = &quot;http://freegeoip.net/json/?callback=handleResponse&quot;;</span><br><span class="line">document.body.insertBefore(script,document.body.firstChild);</span><br></pre></td></tr></table></figure></p>
<p>JSONP的优点在于可以实现浏览器与服务器之间的双向通信,能够直接访问响应文本。但是也存在着两点缺点：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.跨域使用url加载src属性,如果来源域不安全,那么除了完全放弃调用之外别无他法。</span><br><span class="line">2.确认请求是否失败并不容易。</span><br></pre></td></tr></table></figure></p>
<h4 id="commet"><a href="#commet" class="headerlink" title="commet"></a>commet</h4><p>这是一种从服务器向页面推送数据的技术,可以让信息实时的推送到页面上,非常适合体育比赛的分数和股票报价。</p>
<p>一个简单的例子,如果把一次请求看作是去隔壁寝室找同学的过程。短轮询需要过去看一次得到回应(在/不在)之后马上回自己的寝室,再循环这个过程。而长轮询是看到如果不在,那么会接着等,直到等到了再回去,停止这一次的过程,然后又开启新的之前的过程。</p>
<pre><code>所有的浏览器都支持长轮询。
</code></pre><h2 id="CSRF攻击"><a href="#CSRF攻击" class="headerlink" title="CSRF攻击"></a>CSRF攻击</h2><h3 id="CSRF是什么？"><a href="#CSRF是什么？" class="headerlink" title="CSRF是什么？"></a>CSRF是什么？</h3><p>CSRF(Cross Site Request Forgery),中文为跨站点请求伪造。CSRF攻击是攻击者利用用户的身份操作用户帐户的一种攻击方式,attacker在用户登陆目标网站之后,诱使用户访问一个攻击页面,利用目标网站对用户的信任,以用户身份在攻击页面对目标网站发起伪造用户操作的请求,达到攻击的目的。</p>
<p>以下的引用的例子转载于<a href="http://www.cnblogs.com/lovesong/p/5233195.html" target="_blank" rel="noopener">Web安全值CSRF攻击</a></p>
<h4 id="简单版："><a href="#简单版：" class="headerlink" title="简单版："></a>简单版：</h4><p>假设博客园有一个加关注的GET接口,而如下的blogUserGuid参数即为关注人的ID<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.cnblogs.com/mvc/Follow/FollowBlogger.aspx?blogUserGuid=4e8c33d0-77fe-df11-ac81-842b2b196315</span><br></pre></td></tr></table></figure></p>
<p>如果在博客文章的内容中写一个img标签<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img style=&quot;width:0;&quot; src=&quot;http://www.cnblogs.com/mvc/Follow/FollowBlogger.aspx?blogUserGuid=4e8c33d0-77fe-df11-ac81-842b2b196315&quot;   /&gt;</span><br></pre></td></tr></table></figure></p>
<p>那么访问过这篇文章的用户都会自动的关注该ID的用户</p>
<h4 id="升级版"><a href="#升级版" class="headerlink" title="升级版"></a>升级版</h4><p>加入博客园还是有个加关注的接口,但是限制只获取POST请求的数据,这时做一个第三方的页面,其中包含form提交代码,然后通过QQ、邮箱等社交工具传播,诱导用户打开,那么打开过这个页面的用户就会中招了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE HTML&gt;</span><br><span class="line">&lt;html lang=&quot;en-US&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;CSRF SHOW&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">     &lt;body&gt;</span><br><span class="line">          &lt;!--不嵌iframe会跳转--&gt;</span><br><span class="line">          &lt;iframe style=&quot;display:none;&quot;&gt;</span><br><span class="line">               &lt;form  name=&quot;form1&quot; action=&quot;http://www.cnblogs.com/mvc/Follow/FollowBlogger.aspx&quot; method=&quot;post&quot;&gt;</span><br><span class="line">                    &lt;input type=&quot;hidden&quot; name=&quot;blogUserGuid&quot; value=&quot;4e8c33d0-77fe-df11-ac81-842b2b196315&quot;/&gt;</span><br><span class="line">                    &lt;input type=&quot;submit&quot; value&gt;</span><br><span class="line">               &lt;/form&gt;</span><br><span class="line">               &lt;script&gt;</span><br><span class="line">                    document.forms.form1.submit();</span><br><span class="line">               &lt;/script&gt;</span><br><span class="line">          &lt;/iframe&gt;</span><br><span class="line">     &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>如果不加iframe,那么页面会重定向,而这样攻击的隐蔽性显得降低了很多。而如果直接加上iframe,这样也是无效的,因为iframe受限于同源策略,它是无法跨域请求的,在尝试过的所有浏览器中,包括但不限于IE7+、chrome、ff都无法加载iframe的内容,那么form提交也就无效了。如果使用form可以直接跨域post数据,利用一个展示页面内嵌另一个页面的form来post数据可以达到这个目的。示例如下：</p>
<p>展示页面(test)：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE HTML&gt;</span><br><span class="line">&lt;html lang=&quot;en-US&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;CSRF SHOW&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">     &lt;body&gt;</span><br><span class="line">          &lt;iframe style=&quot;display:none;&quot; src=&quot;test2.html&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">     &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>隐藏页面(test2)：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE HTML&gt;</span><br><span class="line">&lt;html lang=&quot;en-US&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;CSRF GET&lt;/title&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">     &lt;form  name=&quot;form1&quot; action=&quot;http://www.cnblogs.com/mvc/Follow/FollowBlogger.aspx&quot; method=&quot;post&quot;&gt;</span><br><span class="line">          &lt;input type=&quot;hidden&quot; name=&quot;blogUserGuid&quot; value=&quot;4e8c33d0-77fe-df11-ac81-842b2b196315&quot;/&gt;</span><br><span class="line">          &lt;input type=&quot;submit&quot; value&gt;</span><br><span class="line">     &lt;/form&gt;</span><br><span class="line">     &lt;script&gt;</span><br><span class="line">          document.forms.form1.submit();</span><br><span class="line">     &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="进阶版"><a href="#进阶版" class="headerlink" title="进阶版"></a>进阶版</h4><p>如果博客园还是有一个加关注的接口,但是已经限制POST,但博文内容是直接贴进HTML(未过滤),那就遭受XSS攻击。只要把上面的代码直接嵌入博文,只要有人打开过这篇博文就会自动的关注,这种组合攻击的方式叫XSRF。</p>
<h3 id="CSRF攻击的本质原因"><a href="#CSRF攻击的本质原因" class="headerlink" title="CSRF攻击的本质原因"></a>CSRF攻击的本质原因</h3><p>CSRF攻击是源于Web的隐式身份验证机制。Web的身份验证机制虽然可以保证一个请求是来自于某个用户的浏览器,但却无法保证该请求是用户批准发送的。CSRF攻击的一般是由服务端解决。</p>
<h3 id="CSRF工具的防御手段"><a href="#CSRF工具的防御手段" class="headerlink" title="CSRF工具的防御手段"></a>CSRF工具的防御手段</h3><ol>
<li>尽量使用POST，限制GET</li>
</ol>
<p>GET接口太容易被拿来做CSRF攻击，看第一个示例就知道，只要构造一个img标签，而img标签又是不能过滤的数据。接口最好限制为POST使用，GET则无效，降低攻击风险。</p>
<p>当然POST并不是万无一失，攻击者只要构造一个form就可以，但需要在第三方页面做，这样就增加暴露的可能性。</p>
<ol start="2">
<li>浏览器Cookie策略</li>
</ol>
<p>IE6、7、8、Safari会默认拦截第三方本地Cookie（Third-party Cookie）的发送。但是Firefox2、3、Opera、Chrome、Android等不会拦截，所以通过浏览器Cookie策略来防御CSRF攻击不靠谱，只能说是降低了风险。</p>
<p>PS：Cookie分为两种，Session Cookie（在浏览器关闭后，就会失效，保存到内存里），Third-party Cookie（即只有到了Exprie时间后才会失效的Cookie，这种Cookie会保存到本地）。</p>
<p>PS：另外如果网站返回HTTP头包含P3P Header，那么将允许浏览器发送第三方Cookie。</p>
<ol start="3">
<li>加验证码</li>
</ol>
<p>验证码，强制用户必须与应用进行交互，才能完成最终请求。在通常情况下，验证码能很好遏制CSRF攻击。但是出于用户体验考虑，网站不能给所有的操作都加上验证码。因此验证码只能作为一种辅助手段，不能作为主要解决方案。</p>
<ol start="4">
<li>Referer Check</li>
</ol>
<p>Referer Check在Web最常见的应用就是“防止图片盗链”。同理，Referer Check也可以被用于检查请求是否来自合法的“源”（Referer值是否是指定页面，或者网站的域），如果都不是，那么就极可能是CSRF攻击。</p>
<p>但是因为服务器并不是什么时候都能取到Referer，所以也无法作为CSRF防御的主要手段。但是用Referer Check来监控CSRF攻击的发生，倒是一种可行的方法。</p>
<ol start="5">
<li>Anti CSRF Token<br>现在业界对CSRF的防御，一致的做法是使用一个Token（Anti CSRF Token）。</li>
</ol>
<p>例子：</p>
<ol>
<li><p>用户访问某个表单页面。</p>
</li>
<li><p>服务端生成一个Token，放在用户的Session中，或者浏览器的Cookie中。</p>
</li>
<li><p>在页面表单附带上Token参数。</p>
</li>
<li><p>用户提交请求后， 服务端验证表单中的Token是否与用户Session（或Cookies）中的Token一致，一致为合法请求，不是则非法请求。</p>
</li>
</ol>
<p>这个Token的值必须是随机的，不可预测的。由于Token的存在，攻击者无法再构造一个带有合法Token的请求实施CSRF攻击。另外使用Token时应注意Token的保密性，尽量把敏感操作由GET改为POST，以form或AJAX形式提交，避免Token泄露。</p>
<p>注意：<br>CSRF的Token仅仅用于对抗CSRF攻击。当网站同时存在XSS漏洞时候，那这个方案也是空谈。所以XSS带来的问题，应该使用XSS的防御方案予以解决。</p>
<h2 id="XSS攻击"><a href="#XSS攻击" class="headerlink" title="XSS攻击"></a>XSS攻击</h2><h3 id="XSS是什么？"><a href="#XSS是什么？" class="headerlink" title="XSS是什么？"></a>XSS是什么？</h3><p>跨站点脚本（Cross-site scripting，XSS）是一种允许攻击者在另一个用户的浏览器中执行恶意脚本的脚本注入式攻击。<br>————————– 待续 ————————</p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/原生ajax、跨域、jQuery的ajax、CSRF/" rel="tag"># 原生ajax、跨域、jQuery的ajax、CSRF</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/06/15/快速了解Require.JS/" rel="next" title="快速了解Require.JS">
                <i class="fa fa-chevron-left"></i> 快速了解Require.JS
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/06/15/数组去重/" rel="prev" title="数组去重">
                数组去重 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="Zoe" />
            
              <p class="site-author-name" itemprop="name">Zoe</p>
              <p class="site-description motion-element" itemprop="description">心之所向，素履以往。</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">24</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">17</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">21</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#全平台兼容的XMLHttpRequest对象"><span class="nav-number">1.</span> <span class="nav-text">全平台兼容的XMLHttpRequest对象</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ajax有没有破坏JS单线程机制"><span class="nav-number">2.</span> <span class="nav-text">Ajax有没有破坏JS单线程机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ajax与setTimeout排队问题"><span class="nav-number">3.</span> <span class="nav-text">Ajax与setTimeout排队问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#原生AJAX封装方法"><span class="nav-number">4.</span> <span class="nav-text">原生AJAX封装方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JSONP"><span class="nav-number">5.</span> <span class="nav-text">JSONP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#同源策略"><span class="nav-number">5.1.</span> <span class="nav-text">同源策略</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XMLHttpRequest实例的属性"><span class="nav-number">6.</span> <span class="nav-text">XMLHttpRequest实例的属性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XHR一级与XHR二级"><span class="nav-number">7.</span> <span class="nav-text">XHR一级与XHR二级</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JQuery中的AJAX"><span class="nav-number">8.</span> <span class="nav-text">JQuery中的AJAX</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cookie、localstorage、sessionstorage"><span class="nav-number">9.</span> <span class="nav-text">cookie、localstorage、sessionstorage</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#共同点"><span class="nav-number">9.1.</span> <span class="nav-text">共同点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#区别"><span class="nav-number">9.2.</span> <span class="nav-text">区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#webstorage的用法"><span class="nav-number">9.3.</span> <span class="nav-text">webstorage的用法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#监听-storage-事件"><span class="nav-number">9.3.1.</span> <span class="nav-text">监听 storage 事件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AJAX跨域请求"><span class="nav-number">10.</span> <span class="nav-text">AJAX跨域请求</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是CORS-cross-origin-resource-sharing"><span class="nav-number">10.1.</span> <span class="nav-text">什么是CORS(cross-origin-resource-sharing)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#跨域的实现原理"><span class="nav-number">10.2.</span> <span class="nav-text">跨域的实现原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IE8、9的XDomainRequest"><span class="nav-number">10.3.</span> <span class="nav-text">IE8、9的XDomainRequest</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其他浏览器的跨域实现"><span class="nav-number">10.4.</span> <span class="nav-text">其他浏览器的跨域实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其他跨域技术"><span class="nav-number">10.5.</span> <span class="nav-text">其他跨域技术</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#JSONP-1"><span class="nav-number">10.5.1.</span> <span class="nav-text">JSONP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#commet"><span class="nav-number">10.5.2.</span> <span class="nav-text">commet</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CSRF攻击"><span class="nav-number">11.</span> <span class="nav-text">CSRF攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CSRF是什么？"><span class="nav-number">11.1.</span> <span class="nav-text">CSRF是什么？</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#简单版："><span class="nav-number">11.1.1.</span> <span class="nav-text">简单版：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#升级版"><span class="nav-number">11.1.2.</span> <span class="nav-text">升级版</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#进阶版"><span class="nav-number">11.1.3.</span> <span class="nav-text">进阶版</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CSRF攻击的本质原因"><span class="nav-number">11.2.</span> <span class="nav-text">CSRF攻击的本质原因</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CSRF工具的防御手段"><span class="nav-number">11.3.</span> <span class="nav-text">CSRF工具的防御手段</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XSS攻击"><span class="nav-number">12.</span> <span class="nav-text">XSS攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#XSS是什么？"><span class="nav-number">12.1.</span> <span class="nav-text">XSS是什么？</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zoe</span>

  

  
</div>


  



  <div class="powered-by">Powered by <a class="theme-link" target="_blank" rel="external nofollow" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" rel="external nofollow" href="https://github.com/theme-next/hexo-theme-next">NexT.Mist</a> v6.3.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



	





  





  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
